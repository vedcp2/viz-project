<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fuel Efficiency in the 1970s</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background-color: #fdfdfd;
      margin: 0;
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
    }
    .scene {
      width: 700px;
      margin: 0 auto;
      text-align: center;
    }
    svg {
      background: #f4f4f4;
      border: 1px solid #ccc;
    }
    .tooltip {
      position: absolute;
      opacity: 0;
      background-color: white;
      border: 1px solid #ccc;
      padding: 8px;
      pointer-events: none;
      font-size: 13px;
    }
    button, select {
      margin: 10px 5px;
      padding: 8px 12px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>Fuel Efficiency and Vehicle Design (1970s)</h1>
  <div id="scene-container" class="scene"></div>
  <div class="tooltip" id="tooltip"></div>

  <script>
    let currentScene = 0;
    const scenes = [scene1, scene2, scene3];

    async function init() {
      const raw = await d3.csv("https://raw.githubusercontent.com/mwaskom/seaborn-data/master/mpg.csv", d3.autoType);
      const data = raw.filter(d => d.mpg && d.weight && d.cylinders && d.origin);
      scenes[currentScene](data);
    }

    function clearScene() {
      d3.select("#scene-container").html("");
    }

    function createSVG(container) {
      const svg = container.append("svg").attr("width", 650).attr("height", 450);
      const margin = {top: 40, right: 40, bottom: 50, left: 60};
      const width = +svg.attr("width") - margin.left - margin.right;
      const height = +svg.attr("height") - margin.top - margin.bottom;
      const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
      return {svg, g, width, height, margin};
    }

    function showTooltip(d, x, y) {
      d3.select("#tooltip")
        .style("left", `${x + 15}px`)
        .style("top", `${y - 20}px`)
        .style("opacity", 0.9)
        .html(`<strong>${d.name}</strong><br>MPG: ${d.mpg}<br>Weight: ${d.weight}<br>Cylinders: ${d.cylinders}<br>Origin: ${d.origin}`);
    }

    function hideTooltip() {
      d3.select("#tooltip").style("opacity", 0);
    }

    function scene1(data) {
      clearScene();
      const container = d3.select("#scene-container").append("div");
      container.append("h2").text("Scene 1: MPG vs. Weight for All Cars");

      const {g, width, height} = createSVG(container);

      const x = d3.scaleLinear().domain(d3.extent(data, d => d.weight)).range([0, width]);
      const y = d3.scaleLinear().domain(d3.extent(data, d => d.mpg)).range([height, 0]);

      g.selectAll("circle")
        .data(data)
        .enter().append("circle")
        .attr("cx", d => x(d.weight))
        .attr("cy", d => y(d.mpg))
        .attr("r", 5)
        .attr("fill", "steelblue")
        .on("mouseover", function(e, d) {
          showTooltip(d, e.pageX, e.pageY);
        })
        .on("mouseout", hideTooltip);

      g.append("g").call(d3.axisLeft(y));
      g.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x));
      g.append("text").attr("x", width/2).attr("y", height + 40).attr("text-anchor", "middle").text("Vehicle Weight");
      g.append("text").attr("x", -30).attr("y", -10).text("MPG");

      container.append("button").text("Next ▶").on("click", () => { currentScene = 1; scenes[1](data); });
    }

    function scene2(data) {
      clearScene();
      const container = d3.select("#scene-container").append("div");
      container.append("h2").text("Scene 2: Highlighting Light and Efficient Cars");

      const {g, width, height} = createSVG(container);

      const x = d3.scaleLinear().domain(d3.extent(data, d => d.weight)).range([0, width]);
      const y = d3.scaleLinear().domain(d3.extent(data, d => d.mpg)).range([height, 0]);

      g.selectAll("circle")
        .data(data)
        .enter().append("circle")
        .attr("cx", d => x(d.weight))
        .attr("cy", d => y(d.mpg))
        .attr("r", 5)
        .attr("fill", d => (d.weight < 2500 && d.mpg > 30) ? "orange" : "#ccc")
        .on("mouseover", function(e, d) {
          showTooltip(d, e.pageX, e.pageY);
        })
        .on("mouseout", hideTooltip);

      g.append("g").call(d3.axisLeft(y));
      g.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x));
      g.append("text").attr("x", width/2).attr("y", height + 40).attr("text-anchor", "middle").text("Vehicle Weight");
      g.append("text").attr("x", -30).attr("y", -10).text("MPG");

      container.append("button").text("◀ Back").on("click", () => { currentScene = 0; scenes[0](data); });
      container.append("button").text("Next ▶").on("click", () => { currentScene = 2; scenes[2](data); });
    }

    function scene3(data) {
      clearScene();
      const container = d3.select("#scene-container").append("div");
      container.append("h2").text("Scene 3: Explore by Origin");

      container.append("label").text("Select Origin: ");
      const dropdown = container.append("select");
      const origins = ["All"].concat([...new Set(data.map(d => d.origin))]);
      dropdown.selectAll("option").data(origins).enter().append("option").text(d => d);

      const chartDiv = container.append("div").attr("id", "chart");

      function draw(filtered) {
        chartDiv.html("");
        const {g, width, height} = createSVG(chartDiv);
        const x = d3.scaleLinear().domain(d3.extent(data, d => d.weight)).range([0, width]);
        const y = d3.scaleLinear().domain(d3.extent(data, d => d.mpg)).range([height, 0]);

        g.selectAll("circle")
          .data(filtered)
          .enter().append("circle")
          .attr("cx", d => x(d.weight))
          .attr("cy", d => y(d.mpg))
          .attr("r", 5)
          .attr("fill", "#17a2b8")
          .on("mouseover", function(e, d) {
            showTooltip(d, e.pageX, e.pageY);
          })
          .on("mouseout", hideTooltip);

        g.append("g").call(d3.axisLeft(y));
        g.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x));
        g.append("text").attr("x", width/2).attr("y", height + 40).attr("text-anchor", "middle").text("Vehicle Weight");
        g.append("text").attr("x", -30).attr("y", -10).text("MPG");
      }

      dropdown.on("change", function() {
        const val = this.value;
        draw(val === "All" ? data : data.filter(d => d.origin === val));
      });

      draw(data);
      container.append("button").text("◀ Back").on("click", () => { currentScene = 1; scenes[1](data); });
    }

    init();
  </script>
</body>
</html>
